# Telegram Bot

Telegram entry point for the Job Agent platform. The bot guides candidates through uploading their CV, kicks off the backend LangGraph workflows, and streams progress updates directly in chat.

## Capabilities

- `/upload` via PDF document upload to sanitize CVs through the PII removal workflow.
- `/search` command that orchestrates scraping, filtering, and processing jobs while reporting progress.
- `/status` and `/cancel` commands for monitoring or stopping long-running searches.
- Rich summaries of relevant jobs, including extracted skills generated by the backend workflows.

## Requirements

- Python 3.9 or newer.
- `TELEGRAM_BOT_TOKEN` from [@BotFather](https://t.me/botfather).
- Backend requirements satisfied for `job-agent-backend`, including `OPENAI_API_KEY`, database connectivity (`DATABASE_URL`), and any scrapper service credentials (see the backend README for details).
- Optional: Docker environment if you prefer containerized execution (`Dockerfile` and `entrypoint.sh` are provided).

## Installation

From the monorepo root:

```bash
pip install -e packages/job-agent-backend
pip install -e packages/telegram_bot
```

With development extras:

```bash
pip install -e "packages/telegram_bot[dev]"
```

## Configuration

Place required settings in a `.env` file at the repository root (loaded automatically by `main.py`):

```bash
TELEGRAM_BOT_TOKEN=123456:example-token-from-botfather
# Additional scrapper service variables as required by job-agent-backend
```

### Access Control

Optionally restrict bot access to specific Telegram users:

```bash
# Comma-separated list of allowed Telegram user IDs
TELEGRAM_ALLOWED_USER_IDS=123456789,987654321
```

- If not set or empty, all users can access the bot (default behavior).
- Unauthorized users are silently ignored (no response).
- To find your Telegram user ID, message [@userinfobot](https://t.me/userinfobot).
- Invalid entries (non-numeric values) are logged and skipped.

Ensure the database is migrated before running the bot. The provided Docker entrypoint runs Alembic migrations for you.

## Usage

```bash
python -m telegram_bot.main
```

After the bot starts:

1. Send your CV as a PDF document to store a sanitized copy for later searches.
2. Run `/search` to trigger the end-to-end pipeline. All parameters are optional:
   - `salary=5000` - Minimum salary filter (default: 4000)
   - `employment=remote` - Employment type (default: remote)
   - `days=7` - Search jobs from last N days
   - `timeout=30` - Request timeout in seconds (default: 30)
3. Use `/status` to check progress or `/cancel` to stop the current search.

### Automatic Date Range Calculation

When the `days` parameter is omitted, the backend automatically determines the search date range:

- **If jobs exist in database**: Uses the `updated_at` timestamp of the most recent stored job as the cutoff date
- **If no jobs exist**: Defaults to the last 5 days
- **5-day cap**: If the last job is older than 5 days, the search is capped at 5 days to prevent excessive scraping after extended inactivity

This "resume from last search" behavior ensures you pick up where you left off without fetching duplicate jobs.

To override this behavior, explicitly provide the `days` parameter (e.g., `/search days=3`).

Note: The date calculation logic is handled by `JobAgentOrchestrator` in the backend, not by the bot itself. The bot simply passes the `days` parameter (or `None` if not specified) to the orchestrator.

### Docker

```bash
cd packages/telegram_bot
docker build -t job-agent-telegram-bot .
docker run --env-file ../../.env job-agent-telegram-bot
```

The container entrypoint applies jobs-repository migrations before starting the bot.

## Project Layout

```
telegram_bot/
├── Dockerfile
├── entrypoint.sh
├── pyproject.toml
└── src/
    └── telegram_bot/
        ├── main.py
        ├── bot.py
        ├── di.py
        ├── access_control.py   # User access control (allowlist)
        └── handlers/
            ├── start/
            ├── help/
            ├── search/
            ├── status/
            ├── cancel/
            └── upload_cv/
```

## Development

- `pytest` once tests are added (project scaffold is ready for it).
- `black src/` for formatting.
- `ruff check src/` for linting.
